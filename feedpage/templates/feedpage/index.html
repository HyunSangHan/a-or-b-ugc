{% extends 'base.html' %}
{% load custom_tags %}
<!--언젠간 지표 트래킹도 구현하고 싶다-->
{% block content %}

{% if is_searched and search_result_num != 0 %}
    <p>{{ search_result_num }}개의 검색결과가 있습니다.</p>
    <hr>
    {% endif %}

    {% for feed in feeds %}
{% if feed.check_visible %}
{% if feed.editnow %}
    <div style="border: 1px solid grey;">
        <a href="/feeds/{{ feed.id }}/editoff">수정안하기</a>
        <form action="/feeds/{{feed.id}}/edit/" method="POST">
        {% csrf_token %} 
        <p>title</p>
        <input name="title" value="{{feed.title}}" required /> <br />
        <p>content</p>
        A: <input name="content_a" value="{{feed.content_a}}" required /> <br />
        B: <input name="content_b" value="{{feed.content_b}}" required /> <br />
        HASH TAG: <input name="hash_tag_raw" placeholder="#이러한 #형태로 #입력하세요" row="400"/> <br />
        <input type="hidden" name="next" value="{{next}}" />
        <input type="submit" value="submit" />
    </form>
    </div>

{% else %}
<ul style = "padding: 0;">
    <li style="border: 0px solid grey; padding-bottom: 50px; list-style-type: none;">
        <h3>{{ feed.title }}</h3>
        {% get_feed_tags feed.id as feed_tags %}
        {% for tag in feed_tags %}
        {% if tag != feed_tags.first %}
        <a href="/feeds/?keyword={{tag}}"># {{ tag }}</a>
        &nbsp&nbsp&nbsp
      </form>

        {% endif %}
        {% endfor %}
    <!-- 팔로우 코드 -->
    <h5>{{feed.creator.username}}
    (구독자: {{ feed.creator.profile.follow_to.all.count }})
    {% if user.is_authenticated %}
        {% if request.user != feed.creator %}
            {% if request.user.profile not in feed.creator.profile.follows.all %}
                <form action = "/feeds/{{ feed.creator.id }}/follow/" method="POST">
                    {% csrf_token %}
                    <input type="submit" value="구독하기" />
                </form>
            {% else %}
                <form action = "/feeds/{{ feed.creator.id }}/follow/" method="POST">
                    {% csrf_token %}
                    <input type="submit" value="구독취소" />
                </form>
            {% endif %}
        {% endif %}
    {% endif %}
    </h5>
        <h6>{{ feed.created_at }}</h6>
        <!--A와 B를 함께 두는 행-->
        <span style="width: 100%; display: inline-flex;">
            <!--A 네모 시작-->
            <div style = "width: 45vw; border-radius: 25px; min-height: 45vw; background-color: white; text-align: center; display: flex; justify-content: center; flex-direction: column; margin: auto;">
            <!--클릭했을 때 노출되는 표시-->
            {% get_upvote_color feed.id user.id as choice %}
            {% if choice == "A" %}
                <div style = "position:absolute; width:45vw; min-height:45vw; border: 2px solid black; border-radius: 25px; opacity:0.9;" >
                    <div style="padding-top: 10px;"><b>Your Choice!</b></div>
                </div>
            {% endif %}

{% comment %} 
로그인이 필요한 서비스입니다 얼럿 넣기
 {% endcomment %}

                <!--A?-->
                <div style = "width: 45vw; border-radius: 25px; min-height: 45vw; background-color: white; text-align: center; display: flex; justify-content: center; flex-direction: column; margin: auto;">
                    <!--글씨만 한 레이어 윗층으로 뽑아내기 위함-->
                    <div style="z-index: 1;">
<!--get방식인데 괜찮을지... + 비로그인일 경우에 누르지 못하도록 비활성화 필요-->
                    <a href="/feeds/{{ feed.id }}/upvote_a">
                        <h4 style="width: 100%;">A</h4>
                        {{feed.content_a}}
                        <p style="width: 100%;">
                        {% get_upvote_a feed.id %}표({% get_upvote_perc_a feed.id %})
                        </p>
                    </a>
                    </div>
                </div>
            </div>
            <!--A 네모 끝-->

            <!--B 네모 시작-->
            <div style = "width: 45vw; border-radius: 25px; min-height: 45vw; background-color: white; text-align: center; display: flex; justify-content: center; flex-direction: column; margin: auto;">
            <!--클릭했을 때 노출되는 표시-->
            {% get_upvote_color feed.id user.id as choice %}
            {% if choice == "B" %}
                <div style = "position:absolute; width:45vw; min-height:45vw; border: 2px solid black; border-radius: 25px; opacity:0.9;" >
                    <div style="padding-top: 10px;"><b>Your Choice!</b></div>
                </div>
            {% endif %}
                <!--B?-->
                <div style = "width: 45vw; border-radius: 25px; min-height: 45vw; background-color: white; text-align: center; display: flex; justify-content: center; flex-direction: column; margin: auto;">
                    <!--글씨만 한 레이어 앞으로 뽑아내기 위함-->
                    <div style="z-index: 1;">
                    <a href="/feeds/{{ feed.id }}/upvote_b">
                    <h4 style="width: 100%;">B</h4>
                    {{feed.content_b}}
                    <p style="width: 100%;">
                    {% get_upvote_b feed.id %}표({% get_upvote_perc_b feed.id %})
                    </p>
                    </a>
                    </div>
                </div>
            </div>
            <!--B 네모 끝-->

        </span>
        <!--show화면도 구현해야함!!!!!!!!!!!!!-->
        <a href="/feeds/{{ feed.id }}">덜보기</a>
    {% if request.user == feed.creator %}
        <a href="/feeds/{{ feed.id }}/edit?next={{request.path}}?page={{feeds.number}}">수정하기</a>
        <a href="/feeds/{{ feed.id }}/editon">당장수정하기</a>


            {% comment %} 딜리트 이렇게하면 안되지!!!!!!!!!!!! {% endcomment %}


        <form action="/feeds/{{ feed.id }}/delete/" method="POST">
            {% csrf_token %}
            {% comment %} <input type="hidden" name="_method" value="DELETE"/> {% endcomment %}
            <input type="submit" value="삭제" />
        </form>
        {% comment %} <a href="/feeds/{{ feed.id }}/delete" onclick="return confirm('정말 삭제하시겠습니까?')">삭제</a> {% endcomment %}
        <span>신고({{feed.report_set.count }}건)</span>
    {% else %}
        {% comment %} <form action="/feeds/{{ feed.id }}/report/" method="POST">
            {% csrf_token %}
            <button>신고({{feed.report_set.count }}건)</button>
        </form> {% endcomment %}
        {% get_report_tf feed.id user.id as report_tf %}   
        {% if report_tf and user.id %}


{% comment %} 

지금 get방식인데 괜찮을까...?
 {% endcomment %}

        <a href="/feeds/{{ feed.id }}/report/" onclick="return alert('이미 신고하셨습니다.')">
            <button>신고({{feed.report_set.count }}건)</button>
        </a>
        {% elif report_tf == False and user.id %}
        <a href="/feeds/{{ feed.id }}/report/" onclick="return confirm('정말 신고하실 건가요?')">
            <button>신고({{feed.report_set.count }}건)</button>
        </a>
        {% else %}
        <span>신고({{feed.report_set.count }}건)</span>
        {% endif %}
    {% endif %}

    <!-- 글 코드 -->
    <p/>

    {% for c in feed.feedcomment_set.all %}
    <strong>{{ c.reactor }} </strong> {% get_side feed.id c.id %} {{ c.content }}
    {% if request.user == c.reactor %}
    <form action="/feeds/{{ feed.id }}/comments/{{ c.id }}/" method="POST">
        {% csrf_token %}
        <button type="submit">댓글 삭제</button>
    </form>
    댓글좋아요({{ c.commentupvote_set.count }})
    {% else %}
    <form action="/feeds/{{ feed.id }}/comments/{{ c.id }}/upvote" method="POST">
        {% csrf_token %}
        {% get_comment_upvote_tf feed.id c.id user.id as comment_upvote_tf %}
        {% if user.is_authenticated %}
            {% if comment_upvote_tf %}
            <button type="submit">댓글좋아요 취소({{ c.commentupvote_set.count }})</button>
            {% else %}
            <button type="submit">댓글좋아요({{ c.commentupvote_set.count }})</button>
            {% endif %}
        {% else %}
            <span>댓글좋아요({{ c.commentupvote_set.count }})</span>
        {% endif %}
    </form>
    {% endif %}
    <br>
    {% endfor %}
    <form action="/feeds/{{ feed.id }}/comments/" method="POST">
    {% csrf_token %}
    <input type="text" name="content" />
    <button type="submit">댓글 달기</button>
    </form>
    <!-- 댓글 코드 끝 -->

    </li>
</ul>
</div>
    {% endif %}
    {% else %}
    신고가 10건 이상 접수되어 숨김처리된 게시글입니다.
    {% endif %}
    {% endfor %} 

    {% if search_result_num == 0 %}
        <div>검색결과가 없습니다.
        {% if user.is_authenticated %}
        <a href="/feeds/new">작성하기</a>를 눌러 <strong>{{ keyword }}</strong>에 대한 
        {% endif %}        
        첫번째 글을 작성해보세요!</div>
    {% else %}
        {% if feeds.has_previous %}
        <a href="?page=1">First</a>
        <a href="?page={{feeds.previous_page_number}}">Previous</a>
        {% endif %}
        <span>{{feeds.number}}</span>
        <span>of</span>
        <span>{{feeds.paginator.num_pages}}</span>
    {% endif %}

    {% if feeds.has_next %}
    <a href="?page={{feeds.next_page_number}}">Next</a>
    <a href="?page={{feeds.paginator.num_pages}}">Last</a>
    {% endif %}

{% endblock content %}